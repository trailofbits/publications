FROM ubuntu:20.04

# Configure timezone so that tzdata dependency does not require user input to
# configure.
ENV TZ=America/New_York
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Install dependencies.
RUN apt-get update && \
    apt-get install -y build-essential wget git vim tclsh

# Vulnerable version of SQLite has been removed from the Apt repository
# (sqlite3-dev=3.31.1-4ubuntu0.3). Instead, build the vulnerable version from
# source using the Apt maintainer's source files.
WORKDIR /sqlite3
RUN git clone git://git.launchpad.net/ubuntu/+source/sqlite3 src
WORKDIR /sqlite3/src
RUN git checkout applied/3.31.1-4ubuntu0.3

# Build an optimized version of the vulnerable library.
WORKDIR /sqlite3/build-optimized
RUN ../src/configure --enable-shared && make

# Build an unoptimized version of the vulnerable library.
WORKDIR /sqlite3/build-unoptimized
ENV CFLAGS="-g -O0"
RUN ../src/configure --enable-shared && make

# Build proofs-of-concept.
COPY ./ /poc
WORKDIR /poc
ENV C_INCLUDE_PATH=/sqlite3/build-optimized \
    LD_FLAGS="-L/sqlite3/build-optimized/.libs"
RUN make
